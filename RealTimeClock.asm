	ORG 0000H
	MOV R2, #00	; KHOI TAO GIA TRI BAN DAU 
	MOV R3, #00
	MOV R4, #00
	MOV R7, #00
	GIAY EQU R2	; Gan thanh ghi R2 cho nhan GIAY
	PHUT EQU R3	; Gan thanh ghi R3 cho nhan PHUT
	GIO EQU R4	; Gan thanh ghi R4 cho nhan GIO
	TEMP EQU R7	; Gan thanh ghi R7 cho nhan TEMP

	MOV P3, #0B		  ;TAT CAC LED DE QUET LED
	MOV TMOD, #10H	 ;TIMER1 MOD 1
	MOV IE, #88H  	;CHO PHEP NGAT TIMER1
	LJMP MAIN
	
	ORG 001BH		; DIA CHI TRINH NGAT
	LJMP ISR		; SAU KHI CO INTERRUPT THI NHAY DEN HAM NAY

	ORG 0030H	   ; KHAI BAO DIA CHI CHUONG TRINH CHINH
MAIN: 
	MOV TH1, 0F4H		  ;NAP GIA TRI CHO TIMER F424H = 62500
	MOV TL1, 024H
	CLR TF1
	SETB TR1					   ;BAT TIMER

HIENTHI:						   ;NHAY VAO HAM HIEN THI (QUET LED)
	JNB P1.5, TANGGIO			   ; KIEM TRA NUT NHAN
	JNB P1.6, TANGPHUT
	JNB P1.7, RESETGIAY
HIENTHI1:
	MOV A, GIO	   ;HIEN GIO
	MOV B, #10
	DIV AB
	
	ACALL BIN2LED		 ; CHUYEN TU BIN RA LED 7 DOAN
	MOV   P2, A
	SETB P3.0
	ACALL DELAY3012US

	MOV A,B
	ACALL BIN2LED
	CLR P3.0
	MOV P2,A
	SETB P3.1
	ACALL DELAY3012US

	MOV A, PHUT		;HIEN PHUT
	MOV B, #10
	DIV AB
	
	ACALL BIN2LED
	CLR P3.1
	MOV   P2, A
	SETB P3.2
	ACALL DELAY3012US

	MOV A,B
	ACALL BIN2LED
	CLR P3.2
	MOV P2,A
	SETB P3.3
	ACALL DELAY3012US

	MOV A, GIAY		;HIEN GIAY
	MOV B, #10
	DIV AB
	
	ACALL BIN2LED
	CLR P3.3
	MOV   P2, A
	SETB P3.4
	ACALL DELAY3012US

	MOV A,B
	ACALL BIN2LED
	CLR P3.4
	MOV P2,A
	SETB P3.5
	ACALL DELAY3012US
	CLR P3.5
	LJMP  HIENTHI		; LAP LAI DE QUET LED LIEN TUC

;----------------------

TANGPHUT:					 ;HAM NUT NHAN TANG PHUT
	ACALL DELAY20MS			 ; DELAY DE CHONG DOI PHIM
	JNB P1.6, $				  ; NEU PHIM VAN CON NHAN THI K LAM GI
	MOV A, PHUT
	CJNE A, #59, PHUT11	; CHUA DU 59PHUT
	MOV PHUT, #00
	LJMP GIO00

PHUT11:
	INC PHUT
	LJMP HIENTHI1
TANGGIO:					; NUT NHAN TANG GIO
	ACALL DELAY20MS
	JNB P1.5, $
GIO00:
	MOV A, GIO
	CJNE A, #23, GIO11	; CHUA DU 24H
	MOV GIO, #00
	LJMP HIENTHI1
GIO11:
	INC GIO
	LJMP HIENTHI1
RESETGIAY:				 ; NUT NHAN RESET GIAY
	ACALL DELAY20MS
	JNB P1.7, $
	MOV GIAY, #00
	LJMP HIENTHI1

ISR:				   ;HAM NGAT INTERRUPT
	INC TEMP	 ;MOI LAN DEM DUOC 62500 NEN PHAI DEM 16 LAN MOI DU 1S=1 TRIEU US
	CLR TF1
	CLR TR1
	MOV TH1, 0F4H		 ; F424H=62500	   
	MOV TL1, 024H
	SETB TR1
	CJNE TEMP, #16, EXIT  ; CHUA DU 1S
	MOV TEMP, #00
	CPL P3.7							; 
	LJMP GIAY0		 ; DU 1S, NHAY TOI HAM TINH TOAN THOI GIAN

GIAY0:
	MOV A, GIAY	   	   
	CJNE A,#59, GIAY1  ; KHONG = 59S
	MOV GIAY, #00	
	LJMP PHUT0		  ; = 59S

GIAY1:
	INC GIAY
	LJMP EXIT

;---------------------------

PHUT0:
	MOV A, PHUT
	CJNE A, #59, PHUT1	; CHUA DU 59PHUT
	MOV PHUT, #00
	LJMP GIO0

PHUT1:
	INC PHUT
	LJMP EXIT

;-------------------

GIO0:
	MOV A, GIO
	CJNE A, #23, GIO1	; CHUA DU 24H	   	;
	MOV GIO, #00
	LJMP EXIT

GIO1:
	INC GIO
	LJMP EXIT

EXIT:
	RETI

;---------------------	

BIN2LED:			   		; HAM CHUYEN DOI BIN SANG LED 7 DOAN DE HIEN SO
	mov		DPTR,#LED
	movc	A,@A+DPTR
RET
LED:
	DB 	          0xC0, 0xF9, 0xA4,0xB0, 0x99, 0x92, 0x82, 0xF8, 0x80, 0x90
;Ma Hien Thi       0      1     2    3    4      5    6     7      8    9
DELAY3012US:
	mov		R5,#251			
again2:
	mov		R6,#12
	djnz	R6,$	   ;2 chu ky máy : 251*12*2= 3012 us
	djnz	R5,again2
RET
/*
12*251=1505*2 chu ky may = 3012
*/

DELAY20MS:
	mov		R5,#100
again1:
	mov		R6,#100
	djnz	R6,$  ; 2 chu ky may, 100*100*2=20000us=20ms
	djnz	R5,again1
RET

END
	
		